# =============================================================================
# Caddyfile - Reverse Proxy Configuration
#
# Caddy provides:
# - Automatic HTTPS (Let's Encrypt)
# - HTTP/2 by default
# - Simple configuration
#
# For local development, use localhost (self-signed cert)
# For production, set DOMAIN environment variable
# =============================================================================

# Global options
{
    # Email for Let's Encrypt notifications
    email {$ACME_EMAIL:admin@example.com}

    # Staging CA for testing (uncomment for production testing)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main site
{$DOMAIN:localhost} {
    # Enable compression
    encode gzip zstd

    # Security headers
    header {
        # Strict Transport Security
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"
        # XSS Protection
        X-XSS-Protection "1; mode=block"
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove server header
        -Server
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # API routes -> Mastra
    handle /api/agents/* {
        reverse_proxy mastra:4000
    }

    handle /api/workflows/* {
        reverse_proxy mastra:4000
    }

    # n8n routes (if enabled)
    # Read-only for external access: block mutations
    @n8n_readonly {
        path /n8n/rest/workflows*
        not method GET HEAD OPTIONS
    }
    respond @n8n_readonly 403

    handle /n8n/* {
        uri strip_prefix /n8n
        reverse_proxy n8n:5678
    }

    # Webhook endpoints for n8n
    handle /webhook/* {
        reverse_proxy n8n:5678
    }

    # Everything else -> Frontend
    handle {
        reverse_proxy frontend:3000
    }

    # Logging
    log {
        output stdout
        format console
        level INFO
    }
}

# Redirect www to non-www
www.{$DOMAIN:localhost} {
    redir https://{$DOMAIN:localhost}{uri} permanent
}
