# BetterAuth + Convex: Complete Setup Guide

> Step-by-step guide for implementing centralized authentication with BetterAuth running on self-hosted Convex. Includes all pitfalls discovered during implementation and how to avoid them.

## Architecture Overview

```
                    ┌──────────────────────────────┐
                    │   Shared Convex Instance      │
                    │   (lucidlabs-convex)          │
                    │                               │
                    │  Port 3210 → convex.lucidlabs.de  (API)
                    │  Port 3211 → auth.lucidlabs.de    (HTTP Actions)
                    │                               │
                    │  BetterAuth runs as HTTP       │
                    │  actions on port 3211          │
                    └──────────┬───────────────────┘
                               │
              Cross-subdomain cookie: .lucidlabs.de
                               │
         ┌─────────────┬───────┴───────┬─────────────┐
    reporting.      cotinga.      invoice.       [future].
    lucidlabs.de    lucidlabs.de  lucidlabs.de   lucidlabs.de
         │              │             │              │
    Next.js proxy   Next.js proxy Next.js proxy  Next.js proxy
    (port 3070)     (port 3050)   (port 3060)    (...)
```

**Key insight:** BetterAuth runs inside Convex HTTP actions (not a standalone Node.js server). Each project's Next.js frontend has a proxy that forwards `/api/auth/*` requests to the shared Convex instance.

## Prerequisites

| Requirement | Version | Purpose |
|-------------|---------|---------|
| `better-auth` | ^1.4.9 | Auth framework |
| `@convex-dev/better-auth` | ^0.10.10 | Convex adapter + HTTP action integration |
| `convex` | ^1.22.0 | Database |
| Next.js | 15+ | Frontend framework |
| Self-hosted Convex | Latest | Two-port architecture (API + HTTP Actions) |

## Step 1: Convex-Auth Project Setup

Create a `convex-auth/` directory at your project root (gitignored — this deploys to the shared Convex instance, not per-project).

### Directory Structure

```
convex-auth/
├── convex/
│   ├── _generated/          # Auto-generated by Convex
│   ├── betterAuth/
│   │   ├── auth.ts          # BetterAuth config (THE MAIN FILE)
│   │   ├── schema.ts        # Auto-generated BetterAuth schema
│   │   └── convex.config.ts # Component registration
│   ├── auth.config.ts       # Convex auth config (CustomJWT)
│   ├── convex.config.ts     # App config (registers betterAuth component)
│   └── http.ts              # HTTP router (registers auth routes)
├── package.json
└── schema.ts
```

### package.json

```json
{
  "name": "lucidlabs-auth-convex",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "convex": "^1.22.0",
    "@convex-dev/better-auth": "^0.10.10",
    "better-auth": "^1.4.9"
  }
}
```

### convex/convex.config.ts

```typescript
import { defineApp } from "convex/server";
import betterAuth from "./betterAuth/convex.config";

const app = defineApp();
app.use(betterAuth);

export default app;
```

### convex/http.ts

```typescript
import { httpRouter } from "convex/server";
import { authComponent, createAuth } from "./betterAuth/auth";

const http = httpRouter();

authComponent.registerRoutes(http, createAuth);

export default http;
```

### convex/auth.config.ts

```typescript
import type { AuthConfig } from "convex/server";

const SITE_URL = process.env.CONVEX_SITE_URL || "https://convex.lucidlabs.de";

export default {
  providers: [
    {
      type: "customJwt" as const,
      issuer: SITE_URL,
      applicationID: "convex",
      algorithm: "RS256" as const,
      jwks: `${SITE_URL}/api/auth/convex/jwks`,
    },
  ],
} satisfies AuthConfig;
```

### convex/betterAuth/auth.ts (THE CRITICAL FILE)

```typescript
import { createClient } from "@convex-dev/better-auth";
import { convex } from "@convex-dev/better-auth/plugins";
import type { GenericCtx } from "@convex-dev/better-auth/utils";
import type { BetterAuthOptions } from "better-auth";
import { betterAuth } from "better-auth";
import { magicLink } from "better-auth/plugins";
import { organization } from "better-auth/plugins";
import { components } from "../_generated/api";
import type { DataModel } from "../_generated/dataModel";
import authConfig from "../auth.config";
import schema from "./schema";

export const authComponent = createClient<DataModel, typeof schema>(
  components.betterAuth,
  { local: { schema }, verbose: false },
);

async function sendMagicLinkEmail(email: string, url: string): Promise<void> {
  const resendApiKey = process.env.RESEND_API_KEY;
  if (!resendApiKey) {
    console.log(`[Auth] RESEND_API_KEY not set. Magic link for ${email}: ${url}`);
    return;
  }

  const response = await fetch("https://api.resend.com/emails", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${resendApiKey}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      from: "LUCIDLABS <onboarding@resend.dev>",
      to: email,
      subject: "Your login link",
      html: `
        <div style="font-family: sans-serif; max-width: 480px; margin: 0 auto;">
          <h2>Sign in to LUCIDLABS</h2>
          <p>Click the button below to sign in. This link expires in 10 minutes.</p>
          <a href="${url}" style="display: inline-block; padding: 12px 24px; background: #171717; color: #fff; text-decoration: none; border-radius: 6px; margin: 16px 0;">
            Sign in
          </a>
          <p style="color: #666; font-size: 13px;">If you didn't request this, you can safely ignore this email.</p>
        </div>
      `,
    }),
  });

  if (!response.ok) {
    const errorBody = await response.text();
    console.error(`[Auth] Resend API error: ${response.status} ${errorBody}`);
    throw new Error(`Failed to send magic link email: ${response.status}`);
  }
}

export const createAuthOptions = (ctx: GenericCtx<DataModel>) => {
  return {
    appName: "LUCIDLABS",
    baseURL: process.env.SITE_URL,
    secret: process.env.BETTER_AUTH_SECRET,
    database: authComponent.adapter(ctx),
    emailAndPassword: { enabled: false },
    advanced: {
      crossSubDomainCookies: {
        enabled: true,
        domain: ".lucidlabs.de",         // ← CRITICAL for cross-subdomain SSO
      },
    },
    trustedOrigins: [                     // ← All project subdomains
      "https://reporting.lucidlabs.de",
      "https://cotinga.lucidlabs.de",
      "https://invoice.lucidlabs.de",
      "https://neola.lucidlabs.de",
    ],
    // PITFALL #1: Convex stores dates as numbers, but BetterAuth cleanup
    // compares with Date objects → deletes ALL tokens. Disable until
    // @convex-dev/better-auth fixes Issue #206.
    verification: {
      disableCleanup: true,
    },
    plugins: [
      magicLink({
        expiresIn: 600,                   // 10 minutes
        sendMagicLink: async ({ email, url }) => {
          await sendMagicLinkEmail(email, url);
        },
      }),
      organization(),
      convex({ authConfig }),
    ],
  } satisfies BetterAuthOptions;
};

export const options = createAuthOptions({} as GenericCtx<DataModel>);

export const createAuth = (ctx: GenericCtx<DataModel>) => {
  return betterAuth(createAuthOptions(ctx));
};
```

## Step 2: Frontend Auth Files

### lib/auth-server.ts — Lazy-Init Pattern (CRITICAL for Docker)

```typescript
/**
 * Server-side auth utilities.
 *
 * ALL env var reads are deferred to request time (not module scope)
 * so that `next build` in Docker doesn't bake in no-op handlers
 * when server-only env vars are absent.
 */

import { NextRequest, NextResponse } from "next/server";

type AuthHandler = {
  GET: (req: NextRequest) => Promise<Response>;
  POST: (req: NextRequest) => Promise<Response>;
};

type AuthUtils = {
  getToken: () => Promise<string | null>;
  handler: AuthHandler;
  isAuthenticated: () => Promise<boolean>;
};

let cachedAuth: AuthUtils | null = null;
let initAttempted = false;

function getAuth(): AuthUtils | null {
  if (cachedAuth) return cachedAuth;
  if (initAttempted) return null;
  initAttempted = true;

  // PITFALL #2: These MUST be read inside a function, NOT at module scope.
  // Module-scope reads are baked at build time → undefined in Docker.
  const authConvexUrl = process.env.AUTH_CONVEX_URL;
  const authConvexSiteUrl = process.env.AUTH_CONVEX_SITE_URL;
  const authEnabled = process.env.NEXT_PUBLIC_AUTH_ENABLED !== "false";

  if (!authConvexUrl || !authConvexSiteUrl || !authEnabled) return null;

  // PITFALL #3: require() instead of import. This is conditional and
  // @vercel/nft can't detect it → needs outputFileTracingIncludes.
  // eslint-disable-next-line @typescript-eslint/no-require-imports
  const { convexBetterAuthNextJs } = require("@convex-dev/better-auth/nextjs");

  const auth = convexBetterAuthNextJs({
    convexSiteUrl: authConvexSiteUrl,  // auth.lucidlabs.de (port 3211)
    convexUrl: authConvexUrl,          // convex.lucidlabs.de (port 3210)
  });

  cachedAuth = {
    getToken: auth.getToken,
    handler: auth.handler,
    isAuthenticated: auth.isAuthenticated,
  };
  return cachedAuth;
}

function noopResponse(): Promise<Response> {
  return Promise.resolve(
    NextResponse.json({ error: "Auth not configured" }, { status: 503 })
  );
}

export const handler: AuthHandler = {
  GET: (req: NextRequest) => getAuth()?.handler.GET(req) ?? noopResponse(),
  POST: (req: NextRequest) => getAuth()?.handler.POST(req) ?? noopResponse(),
};

export const isAuthenticated = (): Promise<boolean> =>
  getAuth()?.isAuthenticated() ?? Promise.resolve(false);

export const getToken = (): Promise<string | null> =>
  getAuth()?.getToken() ?? Promise.resolve(null);
```

### lib/auth-client.ts — Client-Side Auth

```typescript
import { convexClient } from "@convex-dev/better-auth/client/plugins";
import { createAuthClient } from "better-auth/react";
import { magicLinkClient } from "better-auth/client/plugins";
import { organizationClient } from "better-auth/client/plugins";

export const authClient = createAuthClient({
  plugins: [
    convexClient(),
    magicLinkClient(),
    organizationClient(),
  ],
});

export const { useSession, signIn, signOut } = authClient;
```

### lib/auth-helpers.ts — Middleware Session Validation

```typescript
import { NextRequest } from "next/server";

// PITFALL #4: Cookie name changes with HTTPS + crossSubDomainCookies.
// BetterAuth adds __Secure- prefix on HTTPS.
const AUTH_COOKIE_NAMES = [
  "__Secure-better-auth.session_token",  // Production (HTTPS)
  "better-auth.session_token",           // Development (HTTP)
];

interface SessionValidationResult {
  authenticated: boolean;
  userId?: string;
}

function getSessionToken(request: NextRequest): { name: string; value: string } | null {
  for (const name of AUTH_COOKIE_NAMES) {
    const value = request.cookies.get(name)?.value;
    if (value) return { name, value };
  }
  return null;
}

export async function validateSession(
  request: NextRequest
): Promise<SessionValidationResult> {
  const token = getSessionToken(request);
  if (!token) return { authenticated: false };

  // PITFALL #2 again: Read at call time, not module scope.
  const authConvexSiteUrl = process.env.AUTH_CONVEX_SITE_URL;
  if (!authConvexSiteUrl) {
    if (process.env.NEXT_PUBLIC_AUTH_ENABLED === "false") {
      return { authenticated: true, userId: "dev-user" };
    }
    return { authenticated: false };
  }

  try {
    const response = await fetch(`${authConvexSiteUrl}/api/auth/get-session`, {
      headers: { cookie: `${token.name}=${token.value}` },
    });
    if (!response.ok) return { authenticated: false };

    const session = await response.json();
    return session?.user?.id
      ? { authenticated: true, userId: session.user.id }
      : { authenticated: false };
  } catch {
    return { authenticated: false };
  }
}
```

### app/api/auth/[...all]/route.ts — Catch-All Auth Route

```typescript
import { handler } from "@/lib/auth-server";

// PITFALL #5: Without force-dynamic, Next.js may statically optimize this route.
export const dynamic = "force-dynamic";

export const { GET, POST } = handler;
```

### middleware.ts — Route Protection

```typescript
import { NextRequest, NextResponse } from "next/server";
import { validateSession } from "@/lib/auth-helpers";

const PUBLIC_PATHS = ["/login", "/api/auth", "/_next", "/favicon.ico"];
const AUTH_ENABLED = process.env.NEXT_PUBLIC_AUTH_ENABLED !== "false";

export async function middleware(request: NextRequest) {
  if (!AUTH_ENABLED) return NextResponse.next();

  const { pathname } = request.nextUrl;
  if (PUBLIC_PATHS.some((p) => pathname.startsWith(p))) return NextResponse.next();

  const { authenticated } = await validateSession(request);
  if (!authenticated) {
    const loginUrl = new URL("/login", request.url);
    loginUrl.searchParams.set("callbackUrl", pathname);
    return NextResponse.redirect(loginUrl);
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
};
```

### Login Form — MUST Use Absolute callbackURL

```typescript
// PITFALL #6: Relative callbackURL resolves against auth.lucidlabs.de
// (BetterAuth's baseURL), not the project domain. Use absolute URL.
const absoluteCallback = callbackUrl.startsWith("http")
  ? callbackUrl
  : `${window.location.origin}${callbackUrl}`;

const { error } = await authClient.signIn.magicLink({
  email,
  callbackURL: absoluteCallback,
});
```

## Step 3: Next.js Config

### next.config.ts — outputFileTracingIncludes (CRITICAL for Docker)

```typescript
import path from "path";
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: "standalone",
  // PITFALL #3: The conditional require() in auth-server.ts is invisible to
  // @vercel/nft file tracer. These modules would be missing from .next/standalone/.
  outputFileTracingIncludes: {
    "/api/*": [
      "./node_modules/@convex-dev/better-auth/**/*",
      "./node_modules/better-auth/**/*",
    ],
  },
  outputFileTracingRoot: path.join(__dirname, ".."),
};

export default nextConfig;
```

## Step 4: Docker & Environment Variables

### Environment Variable Categories

| Variable | Type | Where Read | Docker Handling |
|----------|------|------------|-----------------|
| `NEXT_PUBLIC_CONVEX_URL` | Build-time | Module scope | Docker build ARG |
| `NEXT_PUBLIC_AUTH_ENABLED` | Build-time | Module scope | Docker build ARG |
| `NEXT_PUBLIC_AUTH_CONVEX_URL` | Build-time | Module scope | Docker build ARG |
| `NEXT_PUBLIC_CONVEX_SITE_URL` | Build-time | Module scope | Docker build ARG |
| `NEXT_PUBLIC_APP_URL` | Build-time | Module scope | Docker build ARG |
| `AUTH_CONVEX_URL` | Runtime | Function body (lazy-init) | Container ENV |
| `AUTH_CONVEX_SITE_URL` | Runtime | Function body (lazy-init) | Container ENV |
| `BETTER_AUTH_SECRET` | Runtime | Container ENV | Container ENV |

### Root .env File (for Docker Compose)

Docker Compose reads `.env` from the same directory as `docker-compose.yml`. This file provides both build args and runtime vars.

```env
# Build args (NEXT_PUBLIC_ baked into Next.js at build time)
NEXT_PUBLIC_CONVEX_URL=https://aware-retriever-410.convex.cloud
NEXT_PUBLIC_AUTH_ENABLED=true
NEXT_PUBLIC_AUTH_CONVEX_URL=https://convex.lucidlabs.de
NEXT_PUBLIC_CONVEX_SITE_URL=https://convex.lucidlabs.de
NEXT_PUBLIC_APP_URL=https://reporting.lucidlabs.de

# Runtime vars (read at request time via lazy-init)
AUTH_CONVEX_URL=https://convex.lucidlabs.de
AUTH_CONVEX_SITE_URL=https://auth.lucidlabs.de
BETTER_AUTH_SECRET=<shared-secret>
```

### docker-compose.yml Auth Section

```yaml
services:
  frontend:
    build:
      args:
        NEXT_PUBLIC_CONVEX_URL: ${NEXT_PUBLIC_CONVEX_URL}
        NEXT_PUBLIC_AUTH_ENABLED: ${NEXT_PUBLIC_AUTH_ENABLED:-true}
        NEXT_PUBLIC_AUTH_CONVEX_URL: ${NEXT_PUBLIC_AUTH_CONVEX_URL:-https://convex.lucidlabs.de}
        NEXT_PUBLIC_CONVEX_SITE_URL: ${NEXT_PUBLIC_CONVEX_SITE_URL:-https://convex.lucidlabs.de}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://reporting.lucidlabs.de}
    environment:
      - AUTH_CONVEX_URL=${AUTH_CONVEX_URL:-https://convex.lucidlabs.de}
      - AUTH_CONVEX_SITE_URL=${AUTH_CONVEX_SITE_URL:-https://auth.lucidlabs.de}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
```

## Step 5: Server Infrastructure

### Caddy Configuration

Two Caddy entries for the shared Convex instance:

```
convex.lucidlabs.de {
    reverse_proxy lucidlabs-convex:3210
}

auth.lucidlabs.de {
    reverse_proxy lucidlabs-convex:3211
}
```

**Why two domains?** Convex serves API (queries, mutations, deploys) on port 3210 and HTTP actions (BetterAuth endpoints) on port 3211. They MUST be separate.

### Convex Environment Variables

Set on the shared Convex instance via `npx convex env set`:

```bash
npx convex env set BETTER_AUTH_SECRET "<shared-secret>" --url https://convex.lucidlabs.de --admin-key "<key>"
npx convex env set SITE_URL "https://auth.lucidlabs.de" --url https://convex.lucidlabs.de --admin-key "<key>"
npx convex env set RESEND_API_KEY "<resend-key>" --url https://convex.lucidlabs.de --admin-key "<key>"
```

### Deploying convex-auth Functions

```bash
cd convex-auth

# Generate admin key
ssh -p 2222 lucidlabs-hq 'sudo docker exec lucidlabs-convex /convex/generate_admin_key.sh' | tail -1

# Deploy
npx convex deploy \
  --url https://convex.lucidlabs.de \
  --admin-key "<generated-admin-key>" \
  --yes
```

## Pitfalls Reference (MUST READ)

### Pitfall #1: INVALID_TOKEN — Verification Cleanup Bug

**Symptom:** Magic link email sends, but clicking returns `?error=INVALID_TOKEN`

**Root Cause:** `@convex-dev/better-auth` [Issue #206](https://github.com/get-convex/better-auth/issues/206). The `findVerificationValue` cleanup compares `new Date()` against Convex `expiresAt` which stores numbers (milliseconds). Type mismatch causes ALL verification records to be deleted.

**Fix:** Add to BetterAuth config:
```typescript
verification: { disableCleanup: true }
```

**Status:** Open bug. Remove workaround when `@convex-dev/better-auth` releases fix.

### Pitfall #2: "Auth not configured" in Docker — Build-Time Baking

**Symptom:** Auth endpoints return 503 `{ error: "Auth not configured" }` in production but work locally.

**Root Cause:** Next.js standalone builds bake module-scope `process.env` reads into compiled chunks. During `docker build`, server-only env vars (`AUTH_CONVEX_URL`, `AUTH_CONVEX_SITE_URL`) are absent → baked as `undefined` permanently.

**Fix:** Use lazy-init pattern — read env vars inside functions, not at module scope:
```typescript
// ❌ WRONG — baked at build time as undefined
const authUrl = process.env.AUTH_CONVEX_URL;

// ✅ CORRECT — read at request time
function getAuth() {
  const authUrl = process.env.AUTH_CONVEX_URL; // runtime read
  // ...
}
```

### Pitfall #3: Missing Modules in Standalone — Conditional require()

**Symptom:** Auth route returns 404 or module-not-found errors in Docker.

**Root Cause:** The `require("@convex-dev/better-auth/nextjs")` is inside a conditional branch that never executes during build. `@vercel/nft` file tracer doesn't detect it → module excluded from `.next/standalone/`.

**Fix:** Add to `next.config.ts`:
```typescript
outputFileTracingIncludes: {
  "/api/*": [
    "./node_modules/@convex-dev/better-auth/**/*",
    "./node_modules/better-auth/**/*",
  ],
},
```

### Pitfall #4: Cookie Name Changes with HTTPS — __Secure- Prefix

**Symptom:** Login appears to succeed (no error) but user is immediately redirected back to `/login`.

**Root Cause:** With `crossSubDomainCookies` enabled on HTTPS, BetterAuth prefixes all cookies with `__Secure-`. The middleware looks for `better-auth.session_token` but the actual cookie is `__Secure-better-auth.session_token`.

**Fix:** Check both cookie names:
```typescript
const AUTH_COOKIE_NAMES = [
  "__Secure-better-auth.session_token",  // Production (HTTPS)
  "better-auth.session_token",           // Development (HTTP)
];
```

### Pitfall #5: Static Route Optimization

**Symptom:** Auth route cached or returns stale responses.

**Root Cause:** Next.js may statically optimize the auth catch-all route.

**Fix:** Add to `app/api/auth/[...all]/route.ts`:
```typescript
export const dynamic = "force-dynamic";
```

### Pitfall #6: Relative callbackURL — Wrong Redirect Domain

**Symptom:** After magic link verification, user redirected to `auth.lucidlabs.de/dashboard` instead of `reporting.lucidlabs.de/dashboard`.

**Root Cause:** BetterAuth's `baseURL` is `auth.lucidlabs.de`. A relative callbackURL (`/dashboard`) resolves against this base.

**Fix:** Always use absolute callbackURL:
```typescript
const absoluteCallback = `${window.location.origin}${callbackUrl}`;
```

### Pitfall #7: Docker Compose .env Not Found

**Symptom:** `NEXT_PUBLIC_CONVEX_URL is not set` during Docker build.

**Root Cause:** Docker Compose reads `.env` from the docker-compose.yml directory. If you rsync with `--delete` and the `.env` doesn't exist locally, it gets deleted on the server.

**Fix:** Either exclude `.env` from rsync (`--exclude=.env`) or create it on the server after rsync.

### Pitfall #8: docker restart vs docker compose up

**Symptom:** Changed env vars not taking effect after container restart.

**Root Cause:** `docker restart` reuses the same container with old environment. Only `docker compose up -d` recreates the container with new env vars.

**Fix:** Always use `docker compose up -d --build` (not `docker restart`).

## Verification Checklist

After deploying auth, verify each step:

```bash
# 1. Convex HTTP actions reachable
curl -s https://auth.lucidlabs.de/api/auth/get-session
# Expected: null (no session) or session JSON

# 2. JWKS endpoint works
curl -s https://auth.lucidlabs.de/api/auth/convex/jwks
# Expected: {"keys":[{"alg":"RS256",...}]}

# 3. Frontend proxy works
curl -s https://reporting.lucidlabs.de/api/auth/get-session
# Expected: null (same as direct)

# 4. Login page loads
curl -s -o /dev/null -w "%{http_code}" https://reporting.lucidlabs.de/login
# Expected: 200

# 5. Magic link sends
curl -s -X POST -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","callbackURL":"https://reporting.lucidlabs.de/dashboard"}' \
  https://auth.lucidlabs.de/api/auth/sign-in/magic-link
# Expected: {"status":true}

# 6. Cookie domain check
curl -s -D - https://auth.lucidlabs.de/api/auth/get-session 2>&1 | grep -i "set-cookie"
# Expected: Domain=.lucidlabs.de

# 7. Build output check
cd frontend && pnpm run build
# Expected: /api/auth/[...all] shows as ƒ (dynamic)
```

## Adding Auth to a New Project

When onboarding a new `*.lucidlabs.de` project:

1. **Add to trustedOrigins** in `convex-auth/convex/betterAuth/auth.ts`
2. **Redeploy convex-auth** to shared Convex
3. **Copy frontend auth files** from reference implementation:
   - `lib/auth-server.ts`, `lib/auth-client.ts`, `lib/auth-helpers.ts`
   - `middleware.ts`
   - `app/api/auth/[...all]/route.ts`
   - `app/login/page.tsx`
   - `components/auth/login-form.tsx`, `components/auth/user-menu.tsx`
4. **Update next.config.ts** with `outputFileTracingIncludes`
5. **Set environment variables** (build args + runtime vars)
6. **Add Caddy entry** for the new subdomain (if not already existing)
7. **Test the full flow** using the verification checklist above

## Email Delivery (Resend)

| Setting | Current Value | Final Value |
|---------|---------------|-------------|
| Provider | Resend | Resend |
| From | `onboarding@resend.dev` (test) | `noreply@lucidlabs.de` (after domain verification) |
| API Key | Set on shared Convex | Same |

**TODO:** Verify `lucidlabs.de` domain in Resend dashboard, add SPF/DKIM DNS records, then update `from` in `convex-auth/convex/betterAuth/auth.ts`.

## Roles & Permissions

| Role | Access | Created By |
|------|--------|------------|
| admin | All projects, user management | System seed |
| team | Assigned projects, extended features | Admin |
| customer | Own org's projects, view + comment | Admin via Magic Link |

---

**Last Updated:** February 2026
**Maintainer:** Lucid Labs GmbH
