# =============================================================================
# LUCIDLABS-HQ - Shared Multi-Project Server
#
# Base infrastructure for hosting multiple Lucid Labs projects on one server.
# Each project runs in its own compose stack but shares the Caddy network.
#
# Location on server: /opt/lucidlabs/
#
# Usage:
#   docker compose up -d                    # Start Caddy + shared services
#   docker compose logs -f caddy            # View Caddy logs
#   docker compose restart caddy            # Reload after Caddyfile changes
# =============================================================================

services:
  # ===========================================================================
  # REVERSE PROXY (Caddy - Auto HTTPS)
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    container_name: lucidlabs-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - lucidlabs-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # WATCHTOWER (Auto-Update)
  # ===========================================================================
  # Automatically updates containers with label "com.centurylinklabs.watchtower.enable=true"
  # Only updates labeled containers (safe for production)
  # See: .claude/reference/watchtower.md
  watchtower:
    image: containrrr/watchtower
    container_name: lucidlabs-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Europe/Berlin
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      # Notifications (optional - configure in .env)
      # - WATCHTOWER_NOTIFICATIONS=slack
      # - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${SLACK_WEBHOOK_URL}
    networks:
      - lucidlabs-network

  # ===========================================================================
  # PORTKEY AI GATEWAY (LLM Proxy)
  # ===========================================================================
  # Central AI Gateway for all projects - cost tracking, fallbacks, caching
  # Dashboard: https://app.portkey.ai (external) or https://portkey.lucidlabs.de
  # API: http://lucidlabs-portkey:8787 (internal)
  portkey:
    image: portkeyai/gateway:latest
    container_name: lucidlabs-portkey
    restart: unless-stopped
    environment:
      - PORTKEY_LOG_LEVEL=info
      # Portkey Dashboard Key (for cost tracking)
      - PORTKEY_API_KEY=${PORTKEY_API_KEY:-}
      # Primary Providers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      # Fallback Providers
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      # EU/GDPR Providers
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      # Budget Providers (GDPR caution - China-based)
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - ZHIPU_API_KEY=${ZHIPU_API_KEY:-}
    networks:
      - lucidlabs-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8787/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # CONVEX (Self-Hosted Realtime Database)
  # ===========================================================================
  # Realtime database for all projects
  # URL: http://lucidlabs-convex:3210 (internal)
  convex:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: lucidlabs-convex
    restart: unless-stopped
    volumes:
      - convex_data:/convex_local_storage
    environment:
      - CONVEX_SITE_URL=${CONVEX_SITE_URL:-http://lucidlabs-convex:3210}
    networks:
      - lucidlabs-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3210/version"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  lucidlabs-network:
    name: lucidlabs-network
    driver: bridge

volumes:
  caddy_data:
    name: lucidlabs-caddy-data
  caddy_config:
    name: lucidlabs-caddy-config
  convex_data:
    name: lucidlabs-convex-data
