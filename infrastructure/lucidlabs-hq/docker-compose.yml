# =============================================================================
# LUCIDLABS-HQ - Shared Multi-Project Server
#
# Base infrastructure for hosting multiple Lucid Labs projects on one server.
# Each project runs in its own compose stack but shares the Caddy network.
#
# Location on server: /opt/lucidlabs/
#
# Usage:
#   docker compose up -d                    # Start Caddy + shared services
#   docker compose logs -f caddy            # View Caddy logs
#   docker compose restart caddy            # Reload after Caddyfile changes
# =============================================================================

services:
  # ===========================================================================
  # REVERSE PROXY (Caddy - Auto HTTPS)
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    container_name: lucidlabs-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - lucidlabs-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # WATCHTOWER (Auto-Update)
  # ===========================================================================
  # Automatically updates containers with label "com.centurylinklabs.watchtower.enable=true"
  # Only updates labeled containers (safe for production)
  # See: .claude/reference/watchtower.md
  watchtower:
    image: containrrr/watchtower
    container_name: lucidlabs-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Europe/Berlin
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      # Notifications (optional - configure in .env)
      # - WATCHTOWER_NOTIFICATIONS=slack
      # - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${SLACK_WEBHOOK_URL}
    networks:
      - lucidlabs-network

networks:
  lucidlabs-network:
    name: lucidlabs-network
    driver: bridge

volumes:
  caddy_data:
    name: lucidlabs-caddy-data
  caddy_config:
    name: lucidlabs-caddy-config
